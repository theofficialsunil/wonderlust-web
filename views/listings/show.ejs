<% layout('layouts/boilerplate') %>

<div class="container my-5">
    <div
        class="card shadow-sm border-0 mx-auto"
        style="max-width: 800px; border-radius: 16px"
    >
        <img
            src="<%= listing.image %>"
            alt="<%= listing.title %>"
            class="card-img-top"
            style="
                border-radius: 16px 16px 0 0;
                height: 400px;
                object-fit: cover;
            "
        />

        <div class="card-body">
            <h2 class="card-title fw-bold mb-3"><%= listing.title %></h2>
            <p class="text-muted mb-2">
                <i class="bi bi-geo-alt-fill text-danger"></i>
                <%= listing.location %>, <%= listing.country %>
            </p>

            <!-- Price -->
            <h5 class="text-dark fw-semibold mb-4">
                ‚Çπ<%= listing.price.toLocaleString() %> / night
            </h5>

            <p class="text-secondary mb-4">
                <%= listing.description || "No description provided." %>
            </p>

            <div class="d-flex align-items-center mb-4 border-top pt-3">
                <img
                    src="<%= listing.owner.profilePhoto %>"
                    alt="<%= listing.owner.username %>"
                    class="rounded-circle me-3 border"
                    style="width: 40px; height: 40px; object-fit: cover"
                />
                <div>
                    <h6 class="mb-0 fw-semibold">
                        Hosted by <%= listing.owner.name %>
                    </h6>
                    <p class="text-muted small mb-0">
                        @<%= listing.owner.username %>
                    </p>
                </div>
            </div>

            <div
                class="d-flex justify-content-between align-items-center flex-wrap gap-2"
            >
                <% if(currentUser && currentUser._id.toString() ===
                listing.owner._id.toString()) { %>
                <a
                    href="/listings/<%= listing._id %>/edit"
                    class="btn btn-outline-primary px-4"
                >
                    ‚úèÔ∏è Edit
                </a>

                <form
                    action="/listings/<%= listing._id %>?_method=DELETE"
                    method="POST"
                    onsubmit="return confirm('Are you sure you want to delete this listing?');"
                >
                    <button type="submit" class="btn btn-outline-danger px-4">
                        üóëÔ∏è Delete
                    </button>
                </form>
                <% } %>

                <a href="/listings" class="btn btn-light border px-4">
                    ‚Üê Back to Listings
                </a>
            </div>
        </div>
    </div>

    <div
        class="card shadow-sm border-0 mx-auto mt-5"
        style="max-width: 800px; border-radius: 16px"
    >
        <div class="card-body">
            <h4 class="fw-semibold mb-3">Add a Review</h4>

            <form action="/listings/<%= listing._id %>/reviews" method="POST">
                <div class="mb-3">
                    <label for="rating" class="form-label">Rating</label>
                    <select
                        name="review[rating]"
                        id="rating"
                        class="form-select"
                        required
                    >
                        <option value="" disabled selected>
                            Select Rating
                        </option>
                        <option value="1">‚≠ê 1</option>
                        <option value="2">‚≠ê‚≠ê 2</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê 3</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4</option>
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="comment" class="form-label">Your Review</label>
                    <textarea
                        name="review[comment]"
                        id="comment"
                        rows="4"
                        class="form-control"
                        placeholder="Share your thoughts..."
                        required
                    ></textarea>
                </div>

                <button
                    type="submit"
                    class="btn w-100"
                    style="background-color: #ff385c; color: white"
                >
                    Submit Review
                </button>
            </form>
        </div>
    </div>

    <div
        class="card shadow-sm border-0 mx-auto mt-5"
        style="max-width: 800px; border-radius: 16px"
    >
        <h4 class="fw-semibold mb-3 px-3 pt-3">Reviews</h4>

        <% if (listing.reviews.length === 0) { %>
        <p class="text-muted px-3 pb-3">
            No reviews yet. Be the first to review!
        </p>
        <% } else { %> <% for (let review of listing.reviews) { %>
        <div class="review-card mb-3 mx-3 p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="stars">
                    <% for (let i = 0; i < review.rating; i++) { %> ‚≠ê <% } %>
                </span>

                <form
                    action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
                    method="POST"
                    onsubmit="return confirm('Are you sure you want to delete this review?');"
                >
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash3"></i>
                    </button>
                </form>
            </div>

            <div class="d-flex align-items-center mb-2">
                <img
                    src="<%= review.author.profilePhoto %>"
                    alt="<%= review.author.username %>"
                    class="rounded-circle me-2 border"
                    style="width: 35px; height: 35px; object-fit: cover"
                />
                <div>
                    <p class="fw-semibold mb-0"><%= review.author.name %></p>
                    <p class="text-muted small mb-0">
                        @<%= review.author.username %>
                    </p>
                </div>
            </div>

            <p class="mb-0 text-secondary"><%= review.comment %></p>
        </div>
        <% } %> <% } %>
    </div>
</div>

<style>
    .btn-outline-primary {
        border-color: #ff385c;
        color: #ff385c;
    }
    .btn-outline-primary:hover {
        background-color: #ff385c;
        color: white;
    }
    .btn-outline-danger {
        border-color: #e0314b;
        color: #e0314b;
    }
    .btn-outline-danger:hover {
        background-color: #e0314b;
        color: white;
    }
    .btn-light:hover {
        background-color: #f5f5f5;
    }
    .review-card {
        background-color: #f8f9fa;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        padding: 15px;
    }
    .stars {
        font-size: 1.2rem;
        color: #ffb400;
    }
</style>
